<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>Roast Master PWA - Standalone</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Fonts -->
    <link href="https://cdn.jsdelivr.net/gh/rastikerdar/vazirmatn@v33.003/Vazirmatn-font-face.css" rel="stylesheet" type="text/css" />
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&display=swap" rel="stylesheet">
    
    <!-- React & Babel -->
    <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
    <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
    
    <!-- HTML to Image (for Price List) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html-to-image/1.11.11/html-to-image.min.js"></script>

    <style>
      body {
        font-family: 'Vazirmatn', sans-serif;
        background-color: #111827;
        color: #f3f4f6;
        -webkit-tap-highlight-color: transparent;
        overflow-x: hidden;
      }
      .font-mono-digital {
        font-family: 'Orbitron', monospace, 'Vazirmatn';
      }
      /* Custom Scrollbar */
      ::-webkit-scrollbar {
        width: 8px;
        height: 8px;
      }
      ::-webkit-scrollbar-track {
        background: #1f2937; 
      }
      ::-webkit-scrollbar-thumb {
        background: #4b5563; 
        border-radius: 4px;
      }
      ::-webkit-scrollbar-thumb:hover {
        background: #6b7280; 
      }
      
      /* Animations */
      @keyframes fade-in {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
      }
      .animate-fade-in {
        animation: fade-in 0.3s ease-out forwards;
      }
      @keyframes drip {
          0% { transform: translateY(-20px) scale(0.5); opacity: 0; }
          20% { opacity: 1; }
          100% { transform: translateY(250px) scale(1); opacity: 0; }
      }
      .animate-drip-1 { animation: drip 1.2s infinite linear; }
      .animate-drip-2 { animation: drip 1.5s infinite linear 0.5s; }
      .animate-drip-3 { animation: drip 1.0s infinite linear 0.2s; }
    </style>
</head>
<body class="bg-gray-900 text-gray-100 min-h-screen">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useCallback, useMemo } = React;

        // --- ICONS ---
        const IconWrapper = ({ children, className, ...props }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className} {...props}>{children}</svg>
        );

        const Flame = (props) => <IconWrapper {...props}><path d="M8.5 14.5A2.5 2.5 0 0 0 11 12c0-1.38-.5-2-1-3-1.072-2.143-.224-4.054 2-6 .5 2.5 2 4.9 4 6.5 2 1.6 3 3.5 3 5.5a7 7 0 1 1-14 0c0-1.153.433-2.294 1-3a2.5 2.5 0 0 0 2.5 2.5z"/></IconWrapper>;
        const Coffee = (props) => <IconWrapper {...props}><path d="M17 8h1a4 4 0 1 1 0 8h-1"/><path d="M3 8h14v9a4 4 0 0 1-4 4H7a4 4 0 0 1-4-4Z"/><line x1="6" x2="6" y1="2" y2="4"/><line x1="10" x2="10" y1="2" y2="4"/><line x1="14" x2="14" y1="2" y2="4"/></IconWrapper>;
        const ClipboardList = (props) => <IconWrapper {...props}><rect width="8" height="4" x="8" y="2" rx="1" ry="1"/><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"/><path d="M12 11h4"/><path d="M12 16h4"/><path d="M8 11h.01"/><path d="M8 16h.01"/></IconWrapper>;
        const Settings = (props) => <IconWrapper {...props}><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1-1-1.74v-.47a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></IconWrapper>;
        const Store = (props) => <IconWrapper {...props}><path d="m2 7 4.41-4.41A2 2 0 0 1 7.83 2h8.34a2 2 0 0 1 1.42.59L22 7"/><path d="M4 12v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-8"/><path d="M15 22v-4a2 2 0 0 0-2-2h-2a2 2 0 0 0-2 2v4"/><path d="M2 7h20"/><path d="M22 7v3a2 2 0 0 1-2 2v0a2.7 2.7 0 0 1-1.59-.63.7.7 0 0 0-.82 0A2.7 2.7 0 0 1 16 12a2.7 2.7 0 0 1-1.59-.63.7.7 0 0 0-.82 0A2.7 2.7 0 0 1 12 12a2.7 2.7 0 0 1-1.59-.63.7.7 0 0 0-.82 0A2.7 2.7 0 0 1 8 12a2.7 2.7 0 0 1-1.59-.63.7.7 0 0 0-.82 0A2.7 2.7 0 0 1 4 12v0a2 2 0 0 1-2-2V7"/></IconWrapper>;
        const ArrowRight = (props) => <IconWrapper {...props}><path d="M5 12h14"/><path d="m12 5 7 7-7 7"/></IconWrapper>;
        const Home = (props) => <IconWrapper {...props}><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></IconWrapper>;
        const Wind = (props) => <IconWrapper {...props}><path d="M17.7 7.7a2.5 2.5 0 1 1 1.8 4.3H2"/><path d="M9.6 4.6A2 2 0 1 1 11 8H2"/><path d="M12.6 19.4A2 2 0 1 0 14 16H2"/></IconWrapper>;
        const RotateCw = (props) => <IconWrapper {...props}><path d="M21 12a9 9 0 1 1-9-9c2.52 0 4.93 1 6.74 2.74L21 8"/><path d="M21 3v5h-5"/></IconWrapper>;
        const Zap = (props) => <IconWrapper {...props}><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></IconWrapper>;
        const LogOut = (props) => <IconWrapper {...props}><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" x2="9" y1="12" y2="12"/></IconWrapper>;
        const Trash2 = (props) => <IconWrapper {...props}><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></IconWrapper>;
        const PlusCircle = (props) => <IconWrapper {...props}><circle cx="12" cy="12" r="10"/><path d="M8 12h8"/><path d="M12 8v8"/></IconWrapper>;
        const Download = (props) => <IconWrapper {...props}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/></IconWrapper>;
        const Share2 = (props) => <IconWrapper {...props}><circle cx="18" cy="5" r="3"/><circle cx="6" cy="12" r="3"/><circle cx="18" cy="19" r="3"/><line x1="8.59" x2="15.42" y1="13.51" y2="17.49"/><line x1="15.41" x2="8.59" y1="6.51" y2="10.49"/></IconWrapper>;
        const Save = (props) => <IconWrapper {...props}><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></IconWrapper>;
        const Upload = (props) => <IconWrapper {...props}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" x2="12" y1="3" y2="15"/></IconWrapper>;
        const Droplets = (props) => <IconWrapper {...props}><path d="M7 16.3c2.2 0 4-1.83 4-4.05 0-1.16-.57-2.26-1.71-3.19S7.29 6.75 7 5.3c-.29 1.45-1.14 2.84-2.29 3.76S3 11.1 3 12.25c0 2.22 1.8 4.05 4 4.05z"/><path d="M12.56 6.6A10.97 10.97 0 0 0 14 3.02c.5 2.5 2 4.9 4 6.5s3 3.5 3 5.5a6.98 6.98 0 0 1-11.91 4.97"/></IconWrapper>;
        const Play = (props) => <IconWrapper {...props}><polygon points="5 3 19 12 5 21 5 3"/></IconWrapper>;
        const CheckCircle = (props) => <IconWrapper {...props}><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></IconWrapper>;
        const AlertCircle = (props) => <IconWrapper {...props}><circle cx="12" cy="12" r="10"/><line x1="12" x2="12" y1="8" y2="12"/><line x1="12" x2="12.01" y1="16" y2="16"/></IconWrapper>;
        const RotateCcw = (props) => <IconWrapper {...props}><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/></IconWrapper>;
        const Square = (props) => <IconWrapper {...props}><rect width="18" height="18" x="3" y="3" rx="2" ry="2"/></IconWrapper>;
        const Clock = (props) => <IconWrapper {...props}><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></IconWrapper>;
        const SkipForward = (props) => <IconWrapper {...props}><polygon points="5 4 15 12 5 20 5 4"/><line x1="19" x2="19" y1="5" y2="19"/></IconWrapper>;
        const BookOpen = (props) => <IconWrapper {...props}><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/></IconWrapper>;
        const Calculator = (props) => <IconWrapper {...props}><rect width="16" height="20" x="4" y="2" rx="2"/><line x1="8" x2="16" y1="6" y2="6"/><line x1="16" x2="16" y1="14" y2="18"/><path d="M16 10h.01"/><path d="M12 10h.01"/><path d="M8 10h.01"/><path d="M12 14h.01"/><path d="M8 14h.01"/><path d="M12 18h.01"/><path d="M8 18h.01"/></IconWrapper>;
        const TrendingUp = (props) => <IconWrapper {...props}><polyline points="23 6 13.5 15.5 8.5 10.5 1 18"/><polyline points="17 6 23 6 23 12"/></IconWrapper>;
        const TrendingDown = (props) => <IconWrapper {...props}><polyline points="23 18 13.5 8.5 8.5 13.5 1 6"/><polyline points="17 18 23 18 23 12"/></IconWrapper>;
        const DollarSign = (props) => <IconWrapper {...props}><line x1="12" x2="12" y1="1" y2="23"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></IconWrapper>;
        const Briefcase = (props) => <IconWrapper {...props}><rect width="20" height="14" x="2" y="7" rx="2" ry="2"/><path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"/></IconWrapper>;
        const Package = (props) => <IconWrapper {...props}><path d="m16.5 9.4-9-5.19"/><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/><polyline points="3.27 6.96 12 12.01 20.73 6.96"/><line x1="12" x2="12" y1="22.08" y2="12"/></IconWrapper>;
        const Edit = (props) => <IconWrapper {...props}><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></IconWrapper>;
        const Edit2 = (props) => <IconWrapper {...props}><path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"/></IconWrapper>;
        const ArrowLeft = (props) => <IconWrapper {...props}><path d="m12 19-7-7 7-7"/><path d="M19 12H5"/></IconWrapper>;
        const ChevronRight = (props) => <IconWrapper {...props}><path d="m9 18 6-6-6-6"/></IconWrapper>;
        const StopCircle = (props) => <IconWrapper {...props}><circle cx="12" cy="12" r="10"/><rect width="6" height="6" x="9" y="9"/></IconWrapper>;
        const Check = (props) => <IconWrapper {...props}><polyline points="20 6 9 17 4 12"/></IconWrapper>;
        const Pause = (props) => <IconWrapper {...props}><rect width="4" height="16" x="6" y="4"/><rect width="4" height="16" x="14" y="4"/></IconWrapper>;
        const Plus = (props) => <IconWrapper {...props}><path d="M5 12h14"/><path d="M12 5v14"/></IconWrapper>;

        // --- HELPERS ---
        const ControlType = { Flame: 'FLAME', DrumFan: 'DRUM_FAN', CoolingFan: 'COOLING_FAN', DrumRotation: 'DRUM_ROTATION', DrumSpeed: 'DRUM_SPEED' };
        const EventType = { FirstCrack: 'FIRST_CRACK', Discharge: 'DISCHARGE', ControlChange: 'CONTROL_CHANGE' };

        const formatTime = (totalSeconds) => {
            const minutes = Math.floor(totalSeconds / 60);
            const seconds = totalSeconds % 60;
            return `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        };

        const toCamelCase = (str) => str.toLowerCase().replace(/_([a-z])/g, (_match, p1) => p1.toUpperCase());

        const getEventDescription = (event, includeTime = true) => {
            const time = formatTime(event.timestamp);
            const timeString = includeTime ? ` در ${time}` : '';
            switch (event.type) {
                case EventType.FirstCrack: return `ترک اول${timeString}`;
                case EventType.Discharge: return `تخلیه${timeString}`;
                case EventType.ControlChange: {
                    const controlLabels = { [ControlType.Flame]: 'شعله', [ControlType.DrumFan]: 'فن درام', [ControlType.CoolingFan]: 'فن کولینگ', [ControlType.DrumRotation]: 'چرخش درام', [ControlType.DrumSpeed]: 'سرعت درام' };
                    const controlLabel = (event.control && controlLabels[event.control]) || event.control;
                    const valueLabel = event.control === ControlType.DrumSpeed ? `${event.value} RPM` : event.value;
                    return `${controlLabel} به ${valueLabel}${timeString}`;
                }
                default: return '';
            }
        };

        function useLocalStorage(key, initialValue) {
            const [storedValue, setStoredValue] = useState(() => {
                try {
                    const item = window.localStorage.getItem(key);
                    return item ? JSON.parse(item) : initialValue;
                } catch (error) { return initialValue; }
            });
            useEffect(() => {
                try { window.localStorage.setItem(key, JSON.stringify(storedValue)); } catch (error) {}
            }, [key, storedValue]);
            return [storedValue, setStoredValue];
        }

        // --- ROAST MASTER COMPONENTS ---
        const RoastTimeline = ({ events, duration, currentTime, isEditing, onEventUpdate, onEventClick, highlightedEventTimestamp }) => {
            const timelineRef = useRef(null);
            const draggingEventRef = useRef(null);

            const getEventIcon = (event) => {
                switch (event.type) {
                    case EventType.FirstCrack: return <Zap className="w-5 h-5 text-orange-400" />;
                    case EventType.Discharge: return <LogOut className="w-5 h-5 text-red-500" />;
                    case EventType.ControlChange:
                        switch (event.control) {
                            case ControlType.Flame: return <Flame className="w-4 h-4 text-red-400" />;
                            case ControlType.DrumFan: case ControlType.CoolingFan: return <Wind className="w-4 h-4 text-cyan-400" />;
                            case ControlType.DrumRotation: case ControlType.DrumSpeed: return <RotateCw className="w-4 h-4 text-green-400" />;
                            default: return <div className="w-2 h-2 bg-gray-400 rounded-full" />;
                        }
                    default: return null;
                }
            };

            const handleMouseDown = (e, roastEvent) => { if (!isEditing || !onEventUpdate) return; draggingEventRef.current = roastEvent; e.preventDefault(); };
            const handleMouseMove = useCallback((e) => {
                if (!draggingEventRef.current || !timelineRef.current || !onEventUpdate) return;
                const timelineBounds = timelineRef.current.getBoundingClientRect();
                const newX = e.clientX - timelineBounds.left;
                const percent = Math.max(0, Math.min(1, newX / timelineBounds.width));
                onEventUpdate({ ...draggingEventRef.current, timestamp: Math.round(percent * duration) });
            }, [duration, onEventUpdate]);
            const handleMouseUp = useCallback(() => { draggingEventRef.current = null; }, []);

            useEffect(() => {
                if (isEditing) { window.addEventListener('mousemove', handleMouseMove); window.addEventListener('mouseup', handleMouseUp); return () => { window.removeEventListener('mousemove', handleMouseMove); window.removeEventListener('mouseup', handleMouseUp); }; }
            }, [isEditing, handleMouseMove, handleMouseUp]);

            return (
                <div className="bg-gray-900 p-4 rounded-lg my-4 border border-gray-800 shadow-inner">
                    <div ref={timelineRef} className="relative w-full h-10 pt-2 pb-2 select-none">
                        <div className="absolute top-1/2 -translate-y-1/2 w-full h-1 bg-gray-700 rounded-full" />
                        {events.map((event, index) => (
                            <div key={`${event.type}-${index}`} className="absolute top-1/2 -translate-y-1/2 group cursor-pointer" style={{ left: `${(event.timestamp / duration) * 100}%`, zIndex: 10 }} onMouseDown={isEditing ? (e) => handleMouseDown(e, event) : undefined} onClick={isEditing ? () => onEventClick?.(event) : undefined}>
                                <div className={`relative flex items-center justify-center -translate-x-1/2 ${isEditing ? 'cursor-grab' : ''}`}>
                                    <div className={`absolute w-full h-full rounded-full transition-transform ${draggingEventRef.current === event ? 'scale-150 bg-amber-500/50' : ''} ${highlightedEventTimestamp === event.timestamp ? 'animate-ping absolute h-6 w-6 rounded-full bg-amber-400 opacity-75' : ''}`} />
                                    <div className="relative bg-gray-800 rounded-full p-1 border border-gray-600 shadow-sm">{getEventIcon(event)}</div>
                                </div>
                            </div>
                        ))}
                        <div className="absolute top-0 bottom-0 w-0.5 bg-amber-500 z-20 pointer-events-none" style={{ left: `${(currentTime / (duration || 1)) * 100}%` }} />
                    </div>
                </div>
            );
        };

        const EventEditModal = ({ event, onSave, onClose }) => {
            const [tempEvent, setTempEvent] = useState(event);
            return (
                <div className="fixed inset-0 bg-black/70 flex items-center justify-center z-[60] p-4 backdrop-blur-sm" onClick={onClose}>
                    <div className="bg-gray-800 p-6 rounded-xl shadow-2xl w-full max-w-md space-y-4 border border-gray-700" onClick={(e) => e.stopPropagation()}>
                        <h2 className="text-xl font-bold text-amber-400">ویرایش</h2>
                        <input type="number" value={tempEvent.timestamp} onChange={(e) => setTempEvent({ ...tempEvent, timestamp: parseInt(e.target.value) || 0 })} className="w-full bg-gray-700 p-3 rounded-md border border-gray-600 text-white" />
                        {tempEvent.control === ControlType.Flame && ['OFF', 'LOW', 'MEDIUM', 'HIGH'].map(v => <button key={v} onClick={() => setTempEvent({...tempEvent, value: v})} className={`mr-2 p-2 rounded ${tempEvent.value===v?'bg-amber-500 text-black':'bg-gray-700'}`}>{v}</button>)}
                        <div className="flex gap-3 pt-4"><button onClick={() => onSave(tempEvent)} className="w-full bg-blue-600 text-white font-bold py-2 rounded">ذخیره</button><button onClick={onClose} className="w-full bg-gray-700 text-white font-bold py-2 rounded">لغو</button></div>
                    </div>
                </div>
            );
        };

        const RoastControlPanel = ({ profileToLoad, onBack, onSave }) => {
            const [isRecording, setIsRecording] = useState(false);
            const [isReplaying, setIsReplaying] = useState(false);
            const [isEditing, setIsEditing] = useState(false);
            const [timer, setTimer] = useState(0);
            const [devTimer, setDevTimer] = useState(0);
            const [firstCrackTime, setFirstCrackTime] = useState(null);
            const [eventToEdit, setEventToEdit] = useState(null);
            const [profileName, setProfileName] = useState('');
            const [greenBeanWeight, setGreenBeanWeight] = useState(0);
            const [chargeTemp, setChargeTemp] = useState(0);
            const [events, setEvents] = useState([]);
            const [editableEvents, setEditableEvents] = useState([]);
            const [controls, setControls] = useState({ flame: 'OFF', drumFan: 'OFF', coolingFan: 'OFF', drumRotation: 'LEFT', drumSpeed: 0 });
            const timerIntervalRef = useRef(null);

            useEffect(() => {
                if (profileToLoad) {
                    setProfileName(profileToLoad.name);
                    setGreenBeanWeight(profileToLoad.greenBeanWeight);
                    setChargeTemp(profileToLoad.chargeTemp);
                    setEvents(profileToLoad.events);
                    const initialControls = { flame: 'OFF', drumFan: 'OFF', coolingFan: 'OFF', drumRotation: 'LEFT', drumSpeed: 0 };
                    profileToLoad.events.filter(e => e.timestamp === 0 && e.type === EventType.ControlChange).forEach(e => initialControls[toCamelCase(e.control)] = e.value);
                    setControls(initialControls);
                } else {
                    setIsRecording(false); setIsReplaying(false); setTimer(0); setDevTimer(0); setFirstCrackTime(null); setEvents([]); setEditableEvents([]);
                }
                return () => clearInterval(timerIntervalRef.current);
            }, [profileToLoad]);

            const startTimer = () => { clearInterval(timerIntervalRef.current); timerIntervalRef.current = setInterval(() => setTimer(p => p + 1), 1000); };
            const handleStart = () => { setIsRecording(true); setEvents([{ timestamp: 0, type: EventType.ControlChange, control: ControlType.Flame, value: controls.flame }]); startTimer(); };
            const handleDischarge = () => {
                setIsRecording(false); clearInterval(timerIntervalRef.current);
                const finalEvents = [...events, { timestamp: timer, type: EventType.Discharge }];
                onSave({ id: profileToLoad?.id || Date.now().toString(), name: profileName, greenBeanWeight, chargeTemp, events: finalEvents, createdAt: new Date().toISOString() });
            };
            const addEvent = (type, control, value) => { if(isRecording) setEvents(p => [...p, { timestamp: timer, type, control, value }]); };
            const handleControl = (key, val) => { setControls(p => ({...p, [key]: val})); addEvent(EventType.ControlChange, ControlType[key.charAt(0).toUpperCase() + key.slice(1)], val); };

            return (
                <div className="p-4 max-w-lg mx-auto bg-gray-800 rounded-xl shadow-2xl space-y-4 mb-24 mt-4 border border-gray-700">
                    {eventToEdit && <EventEditModal event={eventToEdit} onClose={() => setEventToEdit(null)} onSave={(updated) => { setEditableEvents(p => p.map(e => e === eventToEdit ? updated : e)); setEventToEdit(null); }} />}
                    <div className="flex justify-between items-center border-b border-gray-700 pb-4">
                        <h2 className="text-xl font-bold text-amber-400">{isEditing ? 'ویرایش' : profileToLoad ? profileName : 'رُست جدید'}</h2>
                        {!isEditing && <button onClick={onBack} className="text-gray-400">بازگشت</button>}
                    </div>
                    {(isEditing || (!profileToLoad && !isRecording)) && <div className="space-y-3"><input placeholder="نام" value={profileName} onChange={e => setProfileName(e.target.value)} className="w-full bg-gray-900 text-white p-3 rounded-lg" /><div className="flex gap-2"><input type="number" placeholder="وزن" value={greenBeanWeight} onChange={e=>setGreenBeanWeight(Number(e.target.value))} className="w-1/2 bg-gray-900 text-white p-3 rounded-lg"/><input type="number" placeholder="دما" value={chargeTemp} onChange={e=>setChargeTemp(Number(e.target.value))} className="w-1/2 bg-gray-900 text-white p-3 rounded-lg"/></div></div>}
                    {!isEditing && <div className="text-center text-5xl font-bold text-white font-mono-digital my-6">{formatTime(timer)}</div>}
                    {(isRecording || isReplaying || isEditing || (profileToLoad && events.length > 0)) && <RoastTimeline events={isEditing ? editableEvents : events} duration={Math.max(timer, 1200)} currentTime={timer} isEditing={isEditing} onEventClick={setEventToEdit} onEventUpdate={e => setEditableEvents(p => p.map(ev => ev === e ? e : ev))} />}
                    {isRecording && <div className="grid grid-cols-2 gap-2"><button onClick={() => handleControl('flame', controls.flame === 'OFF' ? 'LOW' : 'OFF')} className={`p-3 rounded ${controls.flame !== 'OFF' ? 'bg-red-600' : 'bg-gray-700'}`}>شعله</button><button onClick={() => { setFirstCrackTime(timer); addEvent(EventType.FirstCrack); }} className="bg-orange-600 p-3 rounded">ترک اول</button></div>}
                    <div className="pt-2">{isEditing ? <button onClick={() => { onSave({...profileToLoad, name: profileName, events: editableEvents}); setIsEditing(false); }} className="w-full bg-blue-600 text-white p-3 rounded">ذخیره</button> : isRecording ? <button onClick={handleDischarge} className="w-full bg-red-600 text-white p-3 rounded">تخلیه و ذخیره</button> : profileToLoad && !isReplaying ? <div className="flex gap-2"><button onClick={() => { setIsReplaying(true); startTimer(); }} className="flex-1 bg-blue-600 p-3 rounded">پخش</button><button onClick={() => { setEditableEvents([...events]); setIsEditing(true); }} className="flex-1 bg-amber-600 p-3 rounded">ویرایش</button></div> : !isReplaying && <button onClick={handleStart} className="w-full bg-green-600 text-white p-3 rounded">شروع</button>}</div>
                </div>
            );
        };

        const RoastProfiler = () => {
            const [profiles, setProfiles] = useLocalStorage('roastProfiles', []);
            const [selected, setSelected] = useState(null);
            if (selected) return <RoastControlPanel profileToLoad={selected} onBack={() => setSelected(null)} onSave={p => { setProfiles(prev => { const idx = prev.findIndex(i => i.id === p.id); return idx > -1 ? prev.map(i => i.id === p.id ? p : i) : [...prev, p]; }); setSelected(p); }} />;
            return (
                <div className="p-4 pb-20">
                    <button onClick={() => setSelected(null)} className="w-full bg-amber-500 text-black font-bold py-3 rounded-xl mb-4">+ پروفایل جدید</button>
                    {profiles.map(p => <div key={p.id} onClick={() => setSelected(p)} className="bg-gray-800 p-4 rounded-xl mb-2 flex justify-between items-center cursor-pointer"><div><h3 className="text-white font-bold">{p.name}</h3><p className="text-gray-400 text-sm">{new Date(p.createdAt).toLocaleDateString('fa-IR')}</p></div><Trash2 className="text-red-500" onClick={(e) => { e.stopPropagation(); setProfiles(profiles.filter(i => i.id !== p.id)); }} /></div>)}
                </div>
            );
        };

        // --- COFFEE MASTER COMPONENTS ---
        const defaultRecipes = [
          { id: '1', title: 'اسپرسو دبل', method: 'Espresso', coffeeWeight: 19, waterWeight: 38, grindSize: 'Fine', temp: 93, steps: [{ time: 0, description: 'شروع', waterAmount: 0 }, { time: 5, description: 'اولین قطره', waterAmount: 2 }, { time: 30, description: 'پایان', waterAmount: 38 }] },
          { id: '2', title: 'V60 استاندارد', method: 'V60', coffeeWeight: 20, waterWeight: 320, grindSize: 'Medium-Fine', temp: 93, steps: [{ time: 0, description: 'بلومینگ', waterAmount: 60 }, { time: 45, description: 'ریزش اول', waterAmount: 200 }, { time: 105, description: 'ریزش دوم', waterAmount: 320 }] }
        ];

        const Recipes = ({ onBack }) => {
            const [recipes, setRecipes] = useLocalStorage('brewRecipes', defaultRecipes);
            const [view, setView] = useState('list');
            const [selected, setSelected] = useState(null);
            const [brewTime, setBrewTime] = useState(0);
            const [isBrewing, setIsBrewing] = useState(false);
            const timerRef = useRef(null);

            useEffect(() => { if (isBrewing) timerRef.current = setInterval(() => setBrewTime(t => t + 1), 1000); else clearInterval(timerRef.current); return () => clearInterval(timerRef.current); }, [isBrewing]);

            const renderBrew = () => {
                if (!selected) return null;
                const stepIdx = selected.steps.findIndex(s => s.time > brewTime);
                const currentStep = stepIdx === -1 ? selected.steps[selected.steps.length - 1] : selected.steps[Math.max(0, stepIdx - 1)];
                return (
                    <div className="flex flex-col min-h-[80vh] justify-between pb-32 animate-fade-in">
                        <div className="text-center space-y-2"><h2 className="text-2xl font-bold text-white">{selected.title}</h2><div className="text-gray-400">{selected.coffeeWeight}g قهوه | {selected.waterWeight}ml آب</div></div>
                        <div className="flex justify-center py-8"><div className={`w-64 h-64 rounded-full flex items-center justify-center border-8 transition-all ${isBrewing ? 'border-cyan-500 shadow-[0_0_50px_rgba(6,182,212,0.3)]' : 'border-gray-700'}`}><div className="text-center"><div className="text-7xl font-mono-digital font-bold text-white">{formatTime(brewTime)}</div></div></div></div>
                        <div className="bg-gray-800 rounded-2xl p-6 border border-gray-700 text-center mb-6"><span className="text-cyan-400 font-bold text-xs uppercase">مرحله فعلی</span><h3 className="text-xl font-bold text-white mt-2">{currentStep.description}</h3>{currentStep.waterAmount && <div className="mt-2 text-blue-300">وزن هدف: {currentStep.waterAmount}g</div>}</div>
                        <div className="fixed bottom-0 left-0 right-0 z-50 flex justify-center pointer-events-none"><div className="w-full max-w-lg bg-gray-900 border-t border-gray-800 p-4 pointer-events-auto flex gap-4 shadow-2xl"><button onClick={() => setIsBrewing(!isBrewing)} className={`flex-1 font-bold py-4 rounded-xl flex items-center justify-center gap-2 text-lg ${isBrewing ? 'bg-amber-600 text-white' : 'bg-green-600 text-white'}`}>{isBrewing ? 'توقف' : 'شروع / ادامه'}</button><button onClick={() => { setIsBrewing(false); setBrewTime(0); }} className="bg-gray-700 text-gray-300 p-4 rounded-xl"><RotateCcw /></button></div></div>
                    </div>
                );
            };

            return (
                <div className="p-4 max-w-lg mx-auto h-full">
                    {view !== 'list' && <button onClick={() => setView('list')} className="flex items-center text-gray-400 mb-4"><ArrowRight className="w-5 h-5 ml-1" /> بازگشت</button>}
                    {view === 'list' && <div className="space-y-4">{recipes.map(r => <div key={r.id} onClick={() => { setSelected(r); setView('brew'); }} className="bg-gray-800 p-4 rounded-xl border border-gray-700 cursor-pointer hover:border-cyan-500"><h3 className="font-bold text-white">{r.title}</h3><span className="text-sm text-gray-400">{r.method}</span></div>)}</div>}
                    {view === 'brew' && renderBrew()}
                </div>
            );
        };

        const Backflush = ({ onBack }) => {
            const [phase, setPhase] = useState('intro');
            const [timer, setTimer] = useState(0);
            const [pump, setPump] = useState('off');
            const timerRef = useRef(null);
            useEffect(() => { if (timer > 0) timerRef.current = setInterval(() => setTimer(t => t - 1), 1000); else { clearInterval(timerRef.current); if (pump === 'on') setPump('off'); } return () => clearInterval(timerRef.current); }, [timer, pump]);
            const start = () => { setPump('on'); setTimer(10); };
            return (
                <div className="p-4 max-w-lg mx-auto text-center space-y-6">
                    <div className="flex justify-between"><h2 className="text-2xl text-cyan-400 font-bold">بک‌واش</h2><button onClick={onBack}><ArrowRight/></button></div>
                    {phase === 'intro' ? <button onClick={() => setPhase('run')} className="bg-cyan-600 w-full py-4 rounded-xl font-bold text-white">شروع</button> : <div className="space-y-6"><div className={`text-7xl font-mono-digital font-bold ${pump === 'on' ? 'text-red-500' : 'text-gray-400'}`}>{timer}s</div><button onClick={start} disabled={pump === 'on'} className="bg-green-600 w-full py-4 rounded-xl font-bold text-white">اجرا (10 ثانیه)</button></div>}
                </div>
            );
        };

        const IncomeCalculator = ({ onBack }) => {
            const [data, setData] = useLocalStorage('income', { cost: 5000, price: 30000, count: 50 });
            const profit = (data.price - data.cost) * data.count * 30;
            return (
                <div className="p-4 max-w-lg mx-auto space-y-4">
                    <div className="flex justify-between"><h2 className="text-xl text-emerald-400 font-bold">محاسبه سود</h2><button onClick={onBack}><ArrowRight/></button></div>
                    <div className="bg-emerald-900/20 p-6 rounded-xl border border-emerald-500 text-center"><div className="text-3xl font-bold text-emerald-400">{profit.toLocaleString()}</div><div className="text-sm text-gray-400">سود ماهانه تقریبی</div></div>
                    <input type="number" placeholder="هزینه مواد (کاپ)" value={data.cost} onChange={e=>setData({...data, cost:Number(e.target.value)})} className="w-full bg-gray-800 text-white p-3 rounded"/>
                    <input type="number" placeholder="قیمت فروش" value={data.price} onChange={e=>setData({...data, price:Number(e.target.value)})} className="w-full bg-gray-800 text-white p-3 rounded"/>
                    <input type="number" placeholder="فروش روزانه" value={data.count} onChange={e=>setData({...data, count:Number(e.target.value)})} className="w-full bg-gray-800 text-white p-3 rounded"/>
                </div>
            );
        };

        const MixCalculator = () => {
             const [ingredients, setIngredients] = useState([{ id: '1', name: '', percentage: 100, weight: 1000, pricePerKg: 0 }]);
             const add = () => setIngredients([...ingredients, { id: Date.now().toString(), name: '', percentage: 0, weight: 0, pricePerKg: 0 }]);
             const update = (id, f, v) => setIngredients(ingredients.map(i => i.id===id ? {...i, [f]: v} : i));
             const price = ingredients.reduce((s, i) => s + (Number(i.pricePerKg) * (Number(i.percentage)/100)), 0);
             return (
                 <div className="p-4 max-w-lg mx-auto pb-20">
                     <h1 className="text-2xl font-bold text-center text-amber-400 mb-6">میکس قهوه</h1>
                     <div className="space-y-4 mb-4">{ingredients.map((ing, idx) => (<div key={ing.id} className="bg-gray-800 p-4 rounded-xl border border-gray-700 space-y-3"><div className="flex justify-between"><span className="text-amber-300 font-semibold">ماده {idx+1}</span></div><input type="text" placeholder="نام" value={ing.name} onChange={e => update(ing.id, 'name', e.target.value)} className="w-full bg-gray-700 text-white p-2 rounded-lg border border-gray-600 outline-none" /><div className="grid grid-cols-2 gap-2"><input type="number" placeholder="درصد" value={ing.percentage} onChange={e => update(ing.id, 'percentage', Number(e.target.value))} className="bg-gray-700 text-white p-2 rounded-lg border border-gray-600 outline-none text-center" /><input type="number" placeholder="قیمت" value={ing.pricePerKg} onChange={e => update(ing.id, 'pricePerKg', Number(e.target.value))} className="bg-gray-700 text-white p-2 rounded-lg border border-gray-600 outline-none text-center" /></div></div>))}</div>
                     <button onClick={add} className="w-full bg-gray-700 text-amber-400 py-3 rounded-xl mb-6 flex items-center justify-center gap-2"><PlusCircle className="w-5 h-5"/> افزودن</button>
                     <div className="bg-gray-800 p-5 rounded-xl border border-gray-700 text-center"><p className="text-sm text-gray-400">قیمت تمام شده</p><p className="text-2xl font-bold text-white">{price.toLocaleString()} تومان</p></div>
                 </div>
             );
        };

        const PriceListGenerator = () => <div className="p-4 text-center text-gray-500 mt-10">این بخش در نسخه کامل فعال است.</div>;
        const SettingsPage = () => <div className="p-4 text-center text-gray-500 mt-10">تنظیمات</div>;

        // --- MAIN APP ---
        const CoffeeMaster = () => {
             const [page, setPage] = useState('home');
             if (page === 'recipes') return <Recipes onBack={() => setPage('home')} />;
             if (page === 'backflush') return <Backflush onBack={() => setPage('home')} />;
             if (page === 'income') return <IncomeCalculator onBack={() => setPage('home')} />;
             return (
                 <div className="p-4 max-w-lg mx-auto space-y-4 pt-10">
                     <div className="text-center mb-8"><Coffee className="w-12 h-12 text-cyan-400 mx-auto mb-2"/><h1 className="text-3xl font-bold text-cyan-200">کافی مستر</h1></div>
                     <div className="grid grid-cols-2 gap-4">
                         <button onClick={() => setPage('backflush')} className="bg-gray-800 p-6 rounded-2xl border border-gray-700 hover:border-cyan-500 flex flex-col items-center gap-2"><Droplets className="text-cyan-400"/><span className="font-bold">بک‌واش</span></button>
                         <button onClick={() => setPage('recipes')} className="bg-gray-800 p-6 rounded-2xl border border-gray-700 hover:border-amber-500 flex flex-col items-center gap-2"><BookOpen className="text-amber-400"/><span className="font-bold">دستورالعمل</span></button>
                         <button onClick={() => setPage('income')} className="bg-gray-800 p-6 rounded-2xl border border-gray-700 hover:border-emerald-500 flex flex-col items-center gap-2"><Calculator className="text-emerald-400"/><span className="font-bold">سود</span></button>
                     </div>
                 </div>
             );
        };

        const App = () => {
            const [section, setSection] = useState('portal');
            const [tab, setTab] = useState('roast');

            if (section === 'portal') return (
                <div className="min-h-screen flex flex-col items-center justify-center p-6 bg-gray-900 relative overflow-hidden">
                    <div className="relative z-10 w-full max-w-md space-y-6 text-center">
                        <h1 className="text-4xl font-bold text-amber-400 font-mono-digital mb-8">MASTER SUITE</h1>
                        <button onClick={() => setSection('roast')} className="w-full bg-gray-800 border border-gray-700 p-6 rounded-2xl flex items-center gap-4 hover:border-amber-500"><Flame className="text-amber-500 w-8 h-8"/><span className="text-xl font-bold">رُست مستر</span></button>
                        <button onClick={() => setSection('coffee')} className="w-full bg-gray-800 border border-gray-700 p-6 rounded-2xl flex items-center gap-4 hover:border-cyan-500"><Store className="text-cyan-500 w-8 h-8"/><span className="text-xl font-bold">کافی مستر</span></button>
                    </div>
                </div>
            );

            if (section === 'coffee') return <div className="relative"><button onClick={() => setSection('portal')} className="absolute top-4 right-4 p-2 bg-gray-800 rounded-lg text-cyan-400"><Home/></button><CoffeeMaster/></div>;

            return (
                <div className="min-h-screen flex flex-col pb-20">
                    <button onClick={() => setSection('portal')} className="absolute top-4 right-4 z-50 p-2 bg-gray-800 rounded-lg text-amber-400"><Home/></button>
                    <main className="flex-grow pt-14">
                        {tab === 'roast' && <RoastProfiler />}
                        {tab === 'mix' && <MixCalculator />}
                        {tab === 'price' && <PriceListGenerator />}
                        {tab === 'settings' && <SettingsPage />}
                    </main>
                    <footer className="fixed bottom-0 w-full bg-gray-900 border-t border-gray-700 flex justify-around p-2">
                        <button onClick={() => setTab('roast')} className={`flex flex-col items-center p-2 text-xs ${tab==='roast'?'text-amber-400':'text-gray-500'}`}><Flame className="w-6 h-6 mb-1"/>رُست</button>
                        <button onClick={() => setTab('mix')} className={`flex flex-col items-center p-2 text-xs ${tab==='mix'?'text-amber-400':'text-gray-500'}`}><Coffee className="w-6 h-6 mb-1"/>میکس</button>
                        <button onClick={() => setTab('price')} className={`flex flex-col items-center p-2 text-xs ${tab==='price'?'text-amber-400':'text-gray-500'}`}><ClipboardList className="w-6 h-6 mb-1"/>قیمت</button>
                        <button onClick={() => setTab('settings')} className={`flex flex-col items-center p-2 text-xs ${tab==='settings'?'text-amber-400':'text-gray-500'}`}><Settings className="w-6 h-6 mb-1"/>تنظیمات</button>
                    </footer>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>